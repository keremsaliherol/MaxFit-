@model Maxfit_.Models.Payment

@{
    ViewData["Title"] = "Record New Payment";
}

<div class="container-fluid pt-4 px-4">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="bg-secondary rounded shadow p-4">
                <div class="d-flex align-items-center justify-content-between mb-4 pb-3 border-bottom border-primary">
                    <h5 class="mb-0 text-white">
                        <i class="fa fa-dollar-sign me-2 text-success"></i>Record New Payment
                    </h5>
                    <div class="btn-group">
                        <a asp-action="Index" class="btn btn-sm btn-outline-info">
                            <i class="fa fa-history me-1"></i>View Payment History
                        </a>
                        <a asp-action="Index" class="btn btn-sm btn-outline-light">
                            <i class="fa fa-arrow-left me-1"></i>Back to List
                        </a>
                    </div>
                </div>

                <form asp-action="Create" method="post">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="MemberId" class="form-label text-white">
                                Member <span class="text-danger">*</span>
                            </label>
                            <select asp-for="MemberId" class="form-select bg-dark text-white border-0"
                                asp-items="ViewBag.Members" required>
                                <option value="">-- Select Member --</option>
                            </select>
                            <small class="text-muted">
                                <i class="fa fa-info-circle"></i> Only showing members who haven't paid this month
                            </small>
                            <span asp-validation-for="MemberId" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="MembershipId" class="form-label text-white">
                                Membership Type <small class="text-muted">(Optional)</small>
                            </label>
                            <select asp-for="MembershipId" class="form-select bg-dark text-white border-0"
                                asp-items="ViewBag.MembershipTypes">
                                <option value="">-- Select Membership Type --</option>
                            </select>
                            <span asp-validation-for="MembershipId" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="Amount" class="form-label text-white">
                                Amount ($) <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Amount" class="form-control bg-dark text-white border-0" type="number"
                                step="0.01" placeholder="0.00" required />
                            <span asp-validation-for="Amount" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="PaymentDate" class="form-label text-white">
                                Payment Date <span class="text-danger">*</span>
                            </label>
                            <input asp-for="PaymentDate" class="form-control bg-dark text-white border-0"
                                type="datetime-local" required />
                            <span asp-validation-for="PaymentDate" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="PaymentMethod" class="form-label text-white">
                                Payment Method <span class="text-danger">*</span>
                            </label>
                            <select asp-for="PaymentMethod" class="form-select bg-dark text-white border-0"
                                asp-items="ViewBag.PaymentMethods" required>
                                <option value="">-- Select Method --</option>
                            </select>
                            <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Status" class="form-label text-white">
                                Status <span class="text-danger">*</span>
                            </label>
                            <select asp-for="Status" class="form-select bg-dark text-white border-0"
                                asp-items="ViewBag.PaymentStatuses" required>
                                <option value="">-- Select Status --</option>
                            </select>
                            <span asp-validation-for="Status" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="TransactionId" class="form-label text-white">
                            Transaction ID
                            <small class="text-muted">(for online payments)</small>
                        </label>
                        <input asp-for="TransactionId" class="form-control bg-dark text-white border-0"
                            placeholder="Optional" />
                        <span asp-validation-for="TransactionId" class="text-danger"></span>
                    </div>

                    <div class="mb-4">
                        <label asp-for="Notes" class="form-label text-white">Notes</label>
                        <textarea asp-for="Notes" class="form-control bg-dark text-white border-0" rows="3"
                            placeholder="Additional notes or comments..."></textarea>
                        <span asp-validation-for="Notes" class="text-danger"></span>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end border-top border-dark pt-3">
                        <a asp-action="Index" class="btn btn-outline-light">
                            <i class="fa fa-times me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-success px-4">
                            <i class="fa fa-check me-1"></i>Record Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Set default datetime to now
        if (!document.querySelector('[name="PaymentDate"]').value) {
            var now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.querySelector('[name="PaymentDate"]').value = now.toISOString().slice(0, 16);
        }

        // Auto-fill Membership Type when Member is selected
        $('#MemberId').change(function () {
            var memberId = $(this).val();
            if (memberId) {
                $.get('@Url.Action("GetMemberInfo", "Payments")?memberId=' + memberId, function (data) {
                    if (data.success) {
                        // Set Membership Type dropdown
                        $('#MembershipId').val(data.membershipTypeId).trigger('change');
                    } else {
                        // Clear membership type if member has none
                        $('#MembershipId').val('').trigger('change');
                    }
                });
            } else {
                // Clear everything if no member selected
                    $('#MembershipId').val('');
                    $('#Amount').val('0').prop('readonly', false).removeClass('bg-light');
                }
            });

            // Auto-fill amount when Membership Type is selected
            $('#MembershipId').change(function () {
                var membershipTypeId = $(this).val();
                if (membershipTypeId) {
                    $.get('@Url.Action("GetMembershipTypePrice", "Payments")?membershipTypeId=' + membershipTypeId, function (data) {
                        if (data.success) {
                            $('#Amount').val(data.price).prop('readonly', true).addClass('bg-light');
                        }
                    });
                } else {
                    // If no membership type selected, make amount editable
                    $('#Amount').val('0').prop('readonly', false).removeClass('bg-light');
                }
            });
        </script>
}
