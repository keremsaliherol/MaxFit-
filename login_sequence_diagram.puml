@startuml Login_Sequence_Diagram_Maxfit

skinparam sequence {
    ArrowColor #1976D2
    ActorBorderColor #43A047
    ActorBackgroundColor #E8F5E9
    ParticipantBorderColor #FF6F00
    ParticipantBackgroundColor #FFF3E0
}

title Login Sequence Diagram (Maxfit+)

actor "User\n(Admin/Staff/Member)" as User
participant "Browser" as Browser
participant "AccountController" as Controller
participant "SignInManager" as SignInMgr
participant "UserManager" as UserMgr
database "SQL Server\nDatabase" as DB

== Login Process ==

User -> Browser: Enter email and password
activate Browser

Browser -> Controller: POST /Account/Login
activate Controller

Controller -> SignInMgr: PasswordSignInAsync(email, password, \nrememberMe, lockoutOnFailure)
activate SignInMgr

SignInMgr -> UserMgr: FindByEmailAsync(email)
activate UserMgr

UserMgr -> DB: Query IdentityUser by email
activate DB
DB --> UserMgr: Return user record
deactivate DB

UserMgr --> SignInMgr: ApplicationUser
deactivate UserMgr

SignInMgr -> SignInMgr: Validate password hash

alt Password Valid
    SignInMgr -> SignInMgr: Create authentication cookie
    SignInMgr -> UserMgr: GetRolesAsync(user)
    activate UserMgr
    UserMgr -> DB: Query user roles
    activate DB
    DB --> UserMgr: Return roles (Admin/Staff/Member)
    deactivate DB
    UserMgr --> SignInMgr: User roles
    deactivate UserMgr
    
    SignInMgr -> SignInMgr: Add role claims to cookie
    SignInMgr --> Controller: SignInResult.Success
    deactivate SignInMgr
    
    Controller -> Controller: Determine redirect based on role
    
    alt Admin Role
        Controller --> Browser: Redirect to /Home/Index
    else Staff Role
        Controller --> Browser: Redirect to /Staff/Dashboard
    else Member Role
        Controller --> Browser: Redirect to /Members/MemberDashboard
    end
    
    Browser -> Controller: GET Dashboard URL
    activate Controller
    Controller -> Controller: Load dashboard data
    Controller --> Browser: Render dashboard view
    deactivate Controller
    
    Browser --> User: Display dashboard\n[Success message]
    deactivate Browser
    
else Password Invalid
    SignInMgr --> Controller: SignInResult.Failed
    deactivate SignInMgr
    
    Controller -> Controller: Add error to ModelState
    Controller --> Browser: Return login view with error
    deactivate Controller
    
    Browser --> User: Display error message\n"Invalid login attempt"
    deactivate Browser
end

@enduml
