@startuml Payment_Processing_Sequence_Diagram_Maxfit

skinparam sequence {
    ArrowColor #1976D2
    ActorBorderColor #43A047
    ActorBackgroundColor #E8F5E9
    ParticipantBorderColor #FF6F00
    ParticipantBackgroundColor #FFF3E0
}

title Payment Processing Sequence Diagram (Maxfit+)

actor "Admin/Staff" as Staff
participant "Browser" as Browser
participant "PaymentsController" as Controller
participant "Payment Service" as Service
participant "Member Repository" as MemberRepo
participant "Payment Repository" as PaymentRepo
participant "Email Service" as EmailSvc
database "SQL Server\nDatabase" as DB

== Payment Process ==

Staff -> Browser: Navigate to Payment page
activate Browser

Browser -> Controller: GET /Payments/Create
activate Controller

Controller -> MemberRepo: GetAllActiveMembersAsync()
activate MemberRepo
MemberRepo -> DB: Query active members
activate DB
DB --> MemberRepo: Return members list
deactivate DB
MemberRepo --> Controller: Members list
deactivate MemberRepo

Controller --> Browser: Render payment form with members dropdown
deactivate Controller

Browser --> Staff: Display payment form
deactivate Browser

Staff -> Browser: Select member and fill payment details\n(Membership Type, Amount, Payment Method)
activate Browser

Browser -> Controller: POST /Payments/Create
activate Controller

Controller -> Controller: Validate payment data\n(ModelState validation)

alt Validation Failed
    Controller --> Browser: Return form with validation errors
    Browser --> Staff: Display validation errors
    deactivate Browser
    deactivate Controller
else Validation Success
    
    Controller -> MemberRepo: GetMemberByIdAsync(memberId)
    activate MemberRepo
    MemberRepo -> DB: Query Member
    activate DB
    DB --> MemberRepo: Return Member
    deactivate DB
    MemberRepo --> Controller: Member data
    deactivate MemberRepo
    
    Controller -> Service: ProcessPaymentAsync(paymentData)
    activate Service
    
    Service -> Service: Create Payment record\n(Amount, PaymentDate = Now,\nPaymentMethod, Status)
    
    alt Payment Method = "Online" or "Credit Card"
        Service -> Service: Generate unique TransactionId
        note right
          Future: Integration with
          payment gateway for
          online processing
        end note
        Service -> Service: Set Status = "Pending"
    else Payment Method = "Cash" or "Bank Transfer"
        Service -> Service: Set Status = "Completed"
    end
    
    Service -> PaymentRepo: AddAsync(payment)
    activate PaymentRepo
    PaymentRepo -> DB: INSERT INTO Payments
    activate DB
    DB --> PaymentRepo: Payment saved
    deactivate DB
    PaymentRepo --> Service: Payment record
    deactivate PaymentRepo
    
    alt Payment for Membership
        Service -> Service: Update or create Membership record
        Service -> PaymentRepo: UpdateMembershipAsync()
        activate PaymentRepo
        PaymentRepo -> DB: UPDATE Memberships\nSET StartDate, EndDate, IsActive
        activate DB
        DB --> PaymentRepo: Membership updated
        deactivate DB
        PaymentRepo --> Service: Success
        deactivate PaymentRepo
    end
    
    Service --> Controller: Payment processed
    deactivate Service
    
    par Send Email Notification
        Controller -> EmailSvc: SendPaymentReceiptAsync(member, payment)
        activate EmailSvc
        EmailSvc -> EmailSvc: Create email content\n(Receipt details, Amount, Date,\nPayment Method)
        EmailSvc --> EmailSvc: Send email via SMTP
        note right
          Email contains:
          - Receipt number
          - Payment amount
          - Payment date
          - Payment method
          - Membership details
          - Next payment due date
        end note
        EmailSvc --> Controller: Email sent
        deactivate EmailSvc
    end
    
    Controller -> Controller: Generate success message
    Controller --> Browser: Redirect to /Payments/Index
    deactivate Controller
    
    Browser --> Staff: Display success message\n"Payment processed successfully"
    deactivate Browser
end

@enduml
